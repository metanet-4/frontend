<template>
    <NavBar />
    <div class="wrapper">
        <YouTube
            v-if="youtubeVideoId"
            class="youtube-player"
            :src="`https://www.youtube.com/watch?v=${youtubeVideoId}`"
            @ready="onReady"
            ref="youtube"
            :width="390"
            :height="250"
            :key="youtubeVideoId"
        />

        <div v-if="movie">
            <div class="movie-header">
                <div class="movie-header-info">
                    <h5 class="movie-title">{{ movie.krName }}</h5>
                    <p class="movie-en-title">{{ movie.enName }}</p>
                </div>
                <button @click="toggleLike" :class="liked ? 'liked' : 'unliked'">
                    {{ liked ? '‚ù§Ô∏è' : 'ü§ç' }}
                </button>
                <button @click="bookMovie" class="book-button">ÏòàÎß§ÌïòÍ∏∞</button>
            </div>
            <p class="movie-description">{{ movie.description }}</p>
            <div class="movie-header">
                <h5 class="movie-title">ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h5>
                <button @click="posterDownload" class="book-button2">Ìè¨Ïä§ÌÑ∞ Îã§Ïö¥Î°úÎìú</button>
            </div>
            <hr class="divider" />
            <div class="movie-info">
                <!-- Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Î•º ÏûëÍ≤å ÏÑ§Ï†ï -->
                <img :src="movie.mainImage" alt="ÏòÅÌôî Ïù¥ÎØ∏ÏßÄ" class="movie-image" />

                <!-- ÏòÅÌôî Ï†ïÎ≥¥ ÌëúÏãú -->
                <div class="movie-details">
                    <p>{{ movie.watchGrade }}</p>
                    <p>{{ formatDate(movie.releaseDate) }} {{ movie.openYn }} ¬∑ {{ movie.showTime }}Î∂Ñ</p>
                    <p><strong>Í∞êÎèÖ</strong> {{ movie.directors }}</p>
                    <p><strong>Î∞∞Ïö∞</strong> {{ movie.actors }}</p>
                    <p><strong>Íµ≠Í∞Ä</strong> {{ movie.nation }}</p>
                </div>
            </div>
            <div class="movie-extra-details"></div>
        </div>

        <div class="chart-container">
            <!-- Î∞î Ï∞®Ìä∏ -->
            <div>
                <apexchart width="190" type="bar" :options="chartOptionsBar" :series="seriesBar"></apexchart>
            </div>
            <!-- ÏÉà Î∞î Ï∞®Ìä∏ (ÎÇ®ÏÑ± vs Ïó¨ÏÑ±) -->
            <div>
                <apexchart width="190" type="bar" :options="chartOptionsGender" :series="seriesGender"></apexchart>
            </div>
        </div>
        <!-- ÎèÑÎÑõ Ï∞®Ìä∏ -->
        <div class="chart-container">
            <div class="chart-box">
                <apexchart type="donut" width="200" :options="chartOptionsDoughnut" :series="seriesDoughnut" />
            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, onMounted, watch } from 'vue';
import YouTube from 'vue3-youtube';
import { useRoute } from 'vue-router';
import NavBar from '../components/NavBar.vue';
import axios from 'axios';

const route = useRoute(); // vue-router ÏÇ¨Ïö©ÌïòÏó¨ ÌòÑÏû¨ movieId ÌååÎùºÎØ∏ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞

// Îç∞Ïù¥ÌÑ∞ Î∞è ÏÉÅÌÉú Î≥ÄÏàò ÏÑ§Ï†ï
const movie = ref(null);
const movieChart = ref(null);
const liked = ref(null);
const youtubeVideoId = ref(null);
const seriesBar = ref([{ name: 'ÎàÑÏ†Å Í¥ÄÍ∞ùÏàò', data: [0] }]);
const seriesGender = ref([{ name: 'Í¥ÄÍ∞ù Ïàò', data: [0, 0] }]);
const seriesDoughnut = ref([0, 0, 0, 0, 0, 0, 0, 0]);

const chartOptionsBar = ref({
    chart: { id: 'movie-audience-chart', toolbar: { show: false } },
    plotOptions: {
        bar: { horizontal: false, columnWidth: '60%' },
        borderRadius: 5,
    },
    xaxis: {
        categories: ['ÎàÑÏ†Å Í¥ÄÍ∞ùÏàò'],
        labels: { show: true, style: { fontSize: '12px', fontWeight: 'bold' } },
        axisBorder: { show: false },
        axisTicks: { show: false },
    },
    yaxis: {
        labels: { show: false },
        axisBorder: { show: false },
        axisTicks: { show: false },
    },
    grid: { show: false },
    tooltip: { enabled: false },
    colors: ['#006666'],
    dataLabels: {
        enabled: true, // Îç∞Ïù¥ÌÑ∞ Î†àÏù¥Î∏î ÌëúÏãú
        style: {
            fontSize: '12px',
            fontWeight: 'bold',
        },
        offsetX: 0, // ÌïÑÏöîÏóê Îî∞Îùº ÏúÑÏπò Ï°∞Ï†ï
        offsetY: 0, // ÌïÑÏöîÏóê Îî∞Îùº ÏúÑÏπò Ï°∞Ï†ï
    },
});

const chartOptionsGender = ref({
    chart: { id: 'gender-chart', toolbar: { show: false } },
    plotOptions: {
        bar: { horizontal: false, columnWidth: '50%' },
        borderRadius: 5,
    },
    xaxis: {
        categories: ['ÎÇ®ÏÑ±', 'Ïó¨ÏÑ±'],
        labels: { show: true, style: { fontSize: '12px', fontWeight: 'bold' } },
        axisBorder: { show: false },
        axisTicks: { show: false },
    },
    yaxis: {
        labels: { show: false },
        axisBorder: { show: false },
        axisTicks: { show: false },
    },
    grid: { show: false },
    tooltip: { enabled: true },
    colors: ['#ff9800', '#e91e63'],
});

const chartOptionsDoughnut = ref({
    chart: { type: 'donut', height: 550 },
    labels: ['10ÎåÄ', '20ÎåÄ', '30ÎåÄ', '40ÎåÄ', '50ÎåÄ', '60ÎåÄ', '70ÎåÄ', '80ÎåÄ'],
    colors: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#B8E986'],
    legend: { show: false },
    dataLabels: { enabled: true },
    plotOptions: {
        pie: {
            donut: {
                size: '50%',
            },
        },
    },
    title: {
        text: 'Ïó∞Î†πÎåÄ Î∂ÑÌè¨', // üî• Ï∞®Ìä∏Ïùò Ï†úÎ™© Ï∂îÍ∞Ä
        align: 'center', // Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨
        offsetY: 77, // ÏúÑÏπò Ï°∞Ï†ï (ÏïÑÎûòÏ™ΩÏúºÎ°ú Ïù¥Îèô)
        floating: true,
        style: {
            fontSize: '10px',
            fontWeight: 'bold',
            color: '#333',
        },
    },
});

// ÏòÅÌôî Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ìï®Ïàò
const fetchMovieData = (movieId) => {
    fetch(`http://localhost:8080/movie/detail/${movieId}`, {
        credentials: 'include',
    })
        .then((response) => response.json())
        .then((data) => {
            movie.value = data.movie;
            movieChart.value = data.movieMemberForChart;
            liked.value = data.isLiked;

            const audienceCount = movie.value.totalAudience || 0;
            seriesBar.value = [{ name: 'ÎàÑÏ†Å Í¥ÄÍ∞ùÏàò', data: [audienceCount] }];
            seriesDoughnut.value = [audienceCount];

            const manCount = movieChart.value?.man || 0;
            const womanCount = movieChart.value?.woman || 0;
            seriesGender.value = [{ name: 'Í¥ÄÍ∞ù Ïàò', data: [manCount, womanCount] }];

            seriesDoughnut.value = [
                movieChart.value?.age10th || 0,
                movieChart.value?.age20th || 0,
                movieChart.value?.age30th || 0,
                movieChart.value?.age40th || 0,
                movieChart.value?.age50th || 0,
                movieChart.value?.age60th || 0,
                movieChart.value?.age70th || 0,
                movieChart.value?.age80th || 0,
            ];
        })
        .then((response) => response.json())
        .then((data) => {
            movie.value = data.movie;
            movieChart.value = data.movieMemberForChart;
            liked.value = data.isLiked;

            const audienceCount = movie.value.totalAudience || 0;
            seriesBar.value = [{ name: 'ÎàÑÏ†Å Í¥ÄÍ∞ùÏàò', data: [audienceCount] }];
            seriesDoughnut.value = [audienceCount];

            const manCount = movieChart.value?.man || 0;
            const womanCount = movieChart.value?.woman || 0;
            seriesGender.value = [{ name: 'Í¥ÄÍ∞ù Ïàò', data: [manCount, womanCount] }];

            seriesDoughnut.value = [
                movieChart.value?.age10th || 0,
                movieChart.value?.age20th || 0,
                movieChart.value?.age30th || 0,
                movieChart.value?.age40th || 0,
                movieChart.value?.age50th || 0,
                movieChart.value?.age60th || 0,
                movieChart.value?.age70th || 0,
                movieChart.value?.age80th || 0,
            ];
            //API Ìò∏Ï∂ú Î∂ÄÎ∂Ñ ÎπÑÌôúÏÑ±Ìôî Ï≤òÎ¶¨ (ÏòÅÌôî Ï†úÎ™©ÏúºÎ°ú YouTube ÎπÑÎîîÏò§ Í≤ÄÏÉâ)
            // if (movie.value.krName) {
            //     fetchYouTubeVideo(movie.value.krName);
            // }
        })
        .catch((error) => console.error('Error fetching movie:', error));
};

const formatDate = (timestamp) => {
    const date = new Date(timestamp); // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º Date Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
    return new Intl.DateTimeFormat('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
    }).format(date); // 'yyyy.MM.dd' ÌòïÏãùÏúºÎ°ú Ï∂úÎ†•
};

// Ï¥àÍ∏∞ Î°úÎî© Ïãú ÏòÅÌôî Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
onMounted(() => {
    const movieId = route.params.movieId;
    fetchMovieData(movieId);
});

// movieId Î≥ÄÍ≤Ω Ïãú Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°ú Î°úÎî©
watch(
    () => route.params.movieId, // movieIdÍ∞Ä Î≥ÄÍ≤ΩÎê† Îïå
    (newMovieId) => {
        fetchMovieData(newMovieId);
    }
);

const toggleLike = async () => {
    try {
        const movieId = route.params.movieId;
        const response = await axios.post(`http://localhost:8080/movie/detail/${movieId}`, {
            credentials: 'include',
        });
        if (response.status === 200) {
            liked.value = !liked.value; // Ï¢ãÏïÑÏöî ÏÉÅÌÉú Î∞òÏ†Ñ
        }
    } catch (error) {
        console.error('Ï¢ãÏïÑÏöî Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò Î∞úÏÉù', error);
    }
};

// ÏòàÎß§ÌïòÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠
const bookMovie = () => {
    window.location.href = '/booking';
};

// YouTube API Ìò∏Ï∂úÏùÑ ÏúÑÌïú Ìï®Ïàò
const fetchYouTubeVideo = (query) => {
    const apiKey = 'AIzaSyBBMTorLdM7dwvSjjayraiT8CHXsyZ93t0';
    const searchQuery = `${query} ÏòàÍ≥†Ìé∏`; // ' ÏòàÍ≥†Ìé∏' Ï∂îÍ∞Ä
    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=1&q=${encodeURIComponent(
        searchQuery
    )}&type=video&key=${apiKey}`;

    fetch(url)
        .then((response) => response.json())
        .then((data) => {
            if (data.items && data.items.length > 0) {
                youtubeVideoId.value = data.items[0].id.videoId; // videoIdÎßå Ï∂îÏ∂úÌïòÏó¨ Ï†ÄÏû•
                console.log(youtubeVideoId.value);
            } else {
                youtubeVideoId.value = null;
            }
        })
        .catch((error) => {
            console.error('Error fetching YouTube video:', error);
            youtubeVideoId.value = null;
        });
};

// Ìè¨Ïä§ÌÑ∞ Îã§Ïö¥Î°úÎìú
const posterDownload = async () => {
    console.log(movie.value.mainImage);
    try {
        const response = await axios.get(
            `http://localhost:8080/movie/proxy-image?url=${encodeURIComponent(movie.value.mainImage)}`,
            {
                responseType: 'blob',
            }
        );

        const url = URL.createObjectURL(response.data);
        const link = document.createElement('a');
        link.href = url;

        const filename = movie.value.krName;
        link.download = filename;

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Ìè¨Ïä§ÌÑ∞ Îã§Ïö¥Î°úÎìúÏóê Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.', error);
    }
};
</script>

<style scoped>
.youtube-player {
    max-width: 390px;
}

.chart-container {
    display: flex;
    justify-content: space-around;
    align-items: center;
    width: 100%;
}

.chart-box {
    width: 50%;
    display: flex;
    justify-content: center;
}
</style>

<style scoped>
.wrapper {
    width: 100%;
    max-width: 390px;
    margin: 0 auto;
    position: absolute;
    top: 125px;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    overflow-x: hidden;
    overflow-y: auto;
    background-color: white;
}

.youtube-player {
    max-width: 390px;
}
.chart-container {
    display: flex;
    justify-content: space-around;
    align-items: center;
    width: 100%;
}

.chart-box {
    width: 50%; /* Îëê Í∞úÏùò Ï∞®Ìä∏Í∞Ä Í∑†Îì±ÌïòÍ≤å Î∞∞ÏπòÎê® */
    display: flex;
    justify-content: center; /* Ï∞®Ìä∏ Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ */
}

.apexcharts-svg {
    height: 300px;
}

.movie-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 10px;
    gap: 10px; /* Ï†úÎ™©Í≥º Î≤ÑÌäº ÏÇ¨Ïù¥ Í∞ÑÍ≤© */
}

.movie-header-info {
    flex: 1; /* Î≤ÑÌäºÏùÑ Ï†úÏô∏Ìïú ÎÇòÎ®∏ÏßÄ Í≥µÍ∞ÑÏùÑ Ï∞®ÏßÄÌïòÎèÑÎ°ù ÏÑ§Ï†ï */
    min-width: 0; /* flex ÏÇ¨Ïö© Ïãú, Í∏ÄÏûêÍ∞Ä ÎÑòÏπòÎäî Í≤É Î∞©ÏßÄ */
}

.movie-title {
    font-size: 16px; /* Í∏∞Ï°¥Î≥¥Îã§ ÏÇ¥Ïßù ÏûëÏùÄ ÌÅ¨Í∏∞ */
    font-weight: bold;
    margin: 0;
    word-break: break-word; /* Í∏¥ Ï†úÎ™©ÎèÑ Ï§ÑÎ∞îÍøà Í∞ÄÎä•ÌïòÍ≤å ÏÑ§Ï†ï */
}

.movie-en-title {
    font-size: 14px; /* ÏòÅÏñ¥ Ï†úÎ™©ÎèÑ ÏÇ¥Ïßù ÏûëÏùÄ ÌÅ¨Í∏∞Î°ú Ï°∞Ï†ï */
    color: gray;
    margin: 0;
    word-break: break-word;
}

.book-button {
    background-color: #281b7a; /* ÏòàÏÅú Îπ®Í∞ÑÏÉâ Î≤ÑÌäº */
    color: white;
    border: none;
    padding: 8px 12px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
    white-space: nowrap; /* Î≤ÑÌäºÏùÄ Ìïú Ï§Ñ Ïú†ÏßÄ */
}

.book-button2 {
    background-color: #666666;
    color: white;
    border: none;
    padding: 8px 12px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
    white-space: nowrap; /* Î≤ÑÌäºÏùÄ Ìïú Ï§Ñ Ïú†ÏßÄ */
}

.book-button:hover {
    background-color: #3a2ca4;
}

.book-button2:hover {
    background-color: #777777;
}

.movie-description {
    font-size: 14px;
    line-height: 1.6; /* Ï§Ñ Í∞ÑÍ≤© */
    color: #333; /* Í∏ÄÏûê ÏÉâ */
    background-color: #f8f8f8; /* Î∂ÄÎìúÎü¨Ïö¥ Î∞∞Í≤Ω */
    padding: 10px; /* ÏïàÏ™Ω Ïó¨Î∞± */
    border-radius: 8px; /* Îë•Í∑º Î™®ÏÑúÎ¶¨ */
    word-break: break-word; /* Í∏¥ Îã®Ïñ¥ ÏûêÎèô Ï§ÑÎ∞îÍøà */
    text-align: justify; /* ÏñëÏ™Ω Ï†ïÎ†¨ */
}

.divider {
    border: none;
    height: 1px;
    background-color: #aaa; /* Ïó∞Ìïú ÌöåÏÉâ */
    margin: 16px 0; /* ÏúÑÏïÑÎûò Ïó¨Î∞± */
}

.liked,
.unliked {
    background: none; /* Î∞∞Í≤Ω Ï†úÍ±∞ */
    border: none; /* ÌÖåÎëêÎ¶¨ Ï†úÍ±∞ */
    font-size: 24px; /* ÌïòÌä∏ ÌÅ¨Í∏∞ Ï°∞Ï†à */
    cursor: pointer; /* ÌÅ¥Î¶≠ Í∞ÄÎä• ÌëúÏãú */
    padding: 5px; /* Ïó¨Î∞± Ï∂îÍ∞Ä */
}

.movie-info {
    display: flex;
    align-items: center; /* ÏàòÌèâÏúºÎ°ú Ï†ïÎ†¨ */
}

.movie-image {
    width: 120px; /* Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Î•º ÏûëÍ≤å ÏÑ§Ï†ï */
    margin-right: 10px; /* Ïù¥ÎØ∏ÏßÄÏôÄ ÌÖçÏä§Ìä∏ ÏÇ¨Ïù¥ Í∞ÑÍ≤© */
    margin-bottom: 15px;
}

.movie-details {
    font-size: 15px; /* ÌÖçÏä§Ìä∏ ÌÅ¨Í∏∞ ÏÑ§Ï†ï */
    font-weight: bold;
    line-height: 1.3;
}
</style>
